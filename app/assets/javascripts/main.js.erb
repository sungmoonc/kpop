function redirect_ajax(mode){
	if(window.location.pathname=="/"){
  		main_ajax_filters(mode);
  	} else {
  		mypage_ajax_likes(mode);
  	}	  	  	
}

function signup_ajax(email, password) {
	var request = $.ajax({
		url: '/users/',
		type: 'POST',
		beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},	  		  	
		data: {
			"user":{				
				"email": email,
				"password": password,
				"password_confirmation": password
			}			
		}	
	});

	request.success(function(){		    
		alert("Sign Up Successful");
		$("#signupModal").modal('hide');
		$("#loginModal").modal('show');	
	});

	request.error(function(httpObj, textStatus) {
	  if(httpObj.status!=200){	  	
	  	alert("Email or password is incorrect.");
	  }
	});	
}

function login_ajax(email, password, remember_me) {	
	var request = $.ajax({ 		
		url: '/users/sign_in',		
	  	type: 'POST',	  
	  	beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},	  		  	
		  data: {
		  	"user": {
		        "email": email,
		        "password": password,
		        "remember_me": remember_me
		    }
		  }
		});

	request.success(function(){		    
	    location.href="/";
	});

	request.error(function(httpObj, textStatus) {
	  	if(httpObj.status!=200){	  	
	  		alert("Email or password is incorrect.");
	  	}
	});		  	
}

function render_cards(mode) {		
    	if(mode==="cardview"){
    		$(".cards .box").width("350px");    		
			$("#cards").masonry('reload');	
    	} else if(mode==="cardview2"){
    		$(".cards .box").width("210px");    		
    		$("#cards").masonry('reload');	
    	} else {
    		$("#cards").masonry('reload');	
    		$(".numvalue").number(true);			
    	}    	
}

function main_ajax_filters(mode) { 
	var source = $("#video_card_template").html();  
	
	if(mode==="listview"){
		source = $("#video_list_template").html();
	}  

  	var templatingFunction = Handlebars.compile(source);
  	var context = {};  

  	var form = $("form[name=filters]");

  	$.ajax({
    	url: '/videos/filters_test',
    	type: 'POST',
    	data: form.serialize()
  	}).done(function (response) {
    	context.videos = response.videos;

    	$(".header_panel .numResults").html($.number(response.count) + " results");    	

    	if (form.find("#page").val() == "1") {    
      		$(".thumbnails").empty();      	  
      		$("#sidebar").css("height", 3650);    			   		      		
    	}

    	var cards = $("#cards");

    	if(mode==="cardview" || mode==="cardview2"){
    		cards.imagesLoaded(function() {
				cards.masonry({
					itemSelector: '.box',
					isFitWidth: true			
				});		
			});
    	} else {
    		cards.imagesLoaded(function() {
				cards.masonry({
					itemSelector: '.vlist',
					isFitWidth: true
				});
			});			
    	}	    

    	var newThumbs = templatingFunction(context);
    	$(".thumbnails").append(newThumbs);        	
    	
    	render_cards(mode);
  	});
}

function mypage_ajax_likes(mode) {
	var source = $("#video_card_template").html();  
	
	if(mode==="listview"){
		source = $("#video_list_template").html();
	}  

  	var templatingFunction = Handlebars.compile(source);
  	var context = {};  

  	var form = $("form[name=likeform]");

  	$.ajax({
    	url: '/main/mylikes',
    	type: 'GET',
    	data: form.serialize()
  	}).done(function (response) {
    	context.videos = response.videos;

    	$(".header_panel .numResults").html($.number(response.count) + " likes");    	

    	if (form.find("#page").val() == "1") {    
      		$(".thumbnails").empty();      	  
      		$("#sidebar").css("height", 3650);    			   		      		
    	}

    	var cards = $("#cards");

    	if(mode==="cardview" || mode==="cardview2"){
    		cards.imagesLoaded(function() {
				cards.masonry({
					itemSelector: '.box',
					isFitWidth: true			
				});		
			});
    	} else {
    		cards.imagesLoaded(function() {
				cards.masonry({
					itemSelector: '.vlist',
					isFitWidth: true
				});
			});			
    	}	    

    	var newThumbs = templatingFunction(context);
    	$(".thumbnails").append(newThumbs);        	
    	
    	render_cards(mode);
  	});
}

function mypage_ajax_collections() {
	var source = $("#collection_list_template").html();
	var templatingFunction = Handlebars.compile(source);
  	var context = {};  


}

function viewMenuBtnInit() {
	$(".btn-group .btnView1").attr({ src: "<%= asset_path('main/view_2_n.png') %>"});
	$(".btn-group .btnView2").attr({ src: "<%= asset_path('main/view_3_n.png') %>"});
	$(".btn-group .btnView3").attr({ src: "<%= asset_path('main/view_list_n.png') %>"});
}

function processLike(objData){
	$.ajax({
	    url: '/videos/create_likes',
	    type: 'POST',
	    data: objData
	  }).done(function (response) {		  	
	    if (response["errors"] == undefined) {		    	
	      // var like_count_obj = video.parent().parent().find(".like_count");
	      // like_count_obj.text(parseInt(like_count_obj.text()) + 1);
	      alert("I liked this video");
	    } else {
	      alert(response["errors"])
	    }
	  }).fail(function (response) {
	    alert("You already liked this video")
	  });
}

$(document).on('page:change', function () {		
	var mode = "cardview";

	$("#ipSearch").keyup(function() {
		$("#ipSearchHd").val($(this).val());
		form.trigger("changeT");
	});

	//_left_menu			
	if($("#menutype").val()==0){
		var ipHN = $("#ipHN").slider({}).data("slider");	
		var ipCN = $("#ipCN").slider({}).data("slider");
		var ipEP = $("#ipEP").slider({}).data("slider");		
		var ipAR = $("#ipAR").slider({}).data("slider");	
		$(".inter_slider").on('slideStop', function(newV){
			form.trigger("changeT");
		});	

		$("#tcSubtitle").on("click", function() {
			if($(this).hasClass('on')){
				$(this).removeClass('on');
				$("#ipSubtitle").val("");
			} else {
				$(this).addClass('on');
				$("#ipSubtitle").val("on");
			}
			form.trigger("changeT");
		});

		$("#tcOVideo").on("click", function() {
			if($(this).hasClass('on')){
				$(this).removeClass('on');
				$("#ipOVideo").val("");
			} else {
				$(this).addClass('on');
				$("#ipOVideo").val("on");
			}
			form.trigger("changeT");
		});

		$("#tcLContent").on("click", function() {
			if($(this).hasClass('on')){
				$(this).removeClass('on');
				$("#ipLContent").val("");
			} else {
				$(this).addClass('on');
				$("#ipLContent").val("on");
			}
			form.trigger("changeT");
		});


		$(".dropdown-menu li a").click(function(){
		  $(this).parents(".dropdown").find('.selection').text($(this).text());
		  $(this).parents(".dropdown").find('.selection').val($(this).text());	  	  
		});	

		$("#ddSort li a").click(function() {
			$("#ipSort").val($(this).attr("value"));
			form.trigger("changeT");
		});

		$("#ddVType li a").click(function() {
			$("#ipVType").val($(this).attr("value"));
			form.trigger("changeT");
		});
	}


	//_view_menu_box
	$(".btn-group .btnView1").click(function() {		
		viewMenuBtnInit();
		$(".btn-group .btnView1").attr({ src: "<%= asset_path('main/view_2_p.png') %>"});

		mode = "cardview";
		$("#page").val(1);
		
		redirect_ajax(mode);
	});

	$(".btn-group .btnView2").click(function() {		
		viewMenuBtnInit();
		$(".btn-group .btnView2").attr({ src: "<%= asset_path('main/view_3_p.png') %>"});

		mode = "cardview2";
		$("#page").val(1);
		
		redirect_ajax(mode);
	});

	$(".btn-group .btnView3").click(function() {
		viewMenuBtnInit();
		$(".btn-group .btnView3").attr({ src: "<%= asset_path('main/view_list_p.png') %>"});

		mode = "listview";
		$("#page").val(1);
		
		redirect_ajax(mode);
	});

	//login modal	
	$.ajaxSetup({
	  headers: {
	    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
	  }
	});	

	$("#btnLogin").click(function() {		
		if($("#loginModal #ipEmail").val().length>0 && $("#loginModal #ipPassword").val().length>0){
			var remember = 0;
			if($("#loginModal #cbRemember").is(":checked")==true){
				remember = 1;
			}
			login_ajax($("#loginModal #ipEmail").val(), $("#loginModal #ipPassword").val(), remember);			
		} else {
			alert("Please fill in all fields.");
		}
	});	

	$("#btnSignup").click(function() {				
		var email = $("#signupModal #ipEmail").val();
		var password = $("#signupModal #ipPassword").val();
		var password_confirm = $("#signupModal #ipPasswordConfirm").val();
		console.log(email+"/"+password+"/"+password_confirm);
		if(email.length==0 || password.length==0 || password_confirm.length==0){
			alert("Please fill in all fields.");
			return;
		}

		var regex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
		if(!regex.test(email)){
			alert("Email address is incorrect.");
			return;
		}
		if(password.length<8){
			alert("Password must have 8 characters minimum.");;
			return;
		}
		if(password!==password_confirm){
			alert("Password and Password Confirmation are different.");
			return;
		}

		signup_ajax(email, password);
	});	

	$("#loginModal #link_signup").click(function() {
		$("#loginModal").modal('hide');
		$("#signupModal").modal('show');
	});

	$("#signupModal #link_login").click(function() {
		$("#signupModal").modal('hide');
		$("#loginModal").modal('show');	
	});


	//cards	
	$(".cards").on('mouseover', ".hook--showmodal", function() {
		$(this).find(".overlay").show();
	});

	$(".cards").on('mouseout', ".hook--showmodal", function() {		
		$(this).find(".overlay").hide();
	});

	$(".cards").on('click', ".hook--showmodal", function (e) {		
		var modal = $("#videoModal");
    	var url = $(this).attr("data-href")+"?autoplay=1";
    	modal.find(".iframe").attr('src', url);    	    	

    	var dataWrapper = $(this).find(".dataWrapper");    	
    	modal.find(".titleD").html(dataWrapper.attr("data-title"));    	
    	modal.find(".youtube_user_id").html(dataWrapper.attr("data-youtube-userid"));
    	modal.find(".category").html(dataWrapper.attr("data-category"));
    	modal.find(".upload_date").html(dataWrapper.attr("data-uploaded"));
    	modal.find(".views").find(".value").html($.number(dataWrapper.attr("data-views")));
    	modal.find(".upvotes").find(".value").html($.number(dataWrapper.attr("data-upvotes")));
    	modal.find(".downvotes").find(".value").html($.number(dataWrapper.attr("data-downvotes")));
    	modal.find(".approval").html(dataWrapper.attr("data-approval") + "% Approval");

    	$("#ipViewHN").slider({
    		tooltip: 'always',
    		value: parseInt(dataWrapper.attr("data-hotness")),
    		enabled: false
    	});	
		$("#ipViewCN").slider({
			tooltip: 'always',
			value: parseInt(dataWrapper.attr("data-cheese")),
			enabled: false
		});
  	});

	$(".cards").on('click', ".btnLike", function(e) {					
		e.stopPropagation();				
		
		var objData = {id: $(this).attr("data-video-id")};
		processLike(objData);
	});

	$(".cards").on('click', ".btnAdd", function(e) {
		e.stopPropagation();

		$("#collectionModal").modal('show');		
	});

  	$("#videoModal").on('hidden.bs.modal', function () {
    	$(".main-video .iframe").attr('src', '');    	
  	});

  	$("#videoModal").on('click', '.btnLike', function(e) {
  		e.stopPropagation();

  		var objData = {id: $(this).attr("data-video-id")};
		processLike(objData);
  	});

  	$("#collectionModal .add-collection").on("click", "#btnAdd", function(e) {
  		var collection_id = $(this).val();
  		var collection_name = $("#ipCreateCol").val();
  		if(collection_name.length > 0){
  			$.ajax({
	          url: '/videos/add_to_new_collection',
	          type: 'POST',
	          data: {
	            "name": collection_name,
	            "video_id": $(this).attr("data-video-id")
	          }
	        }).done(function() {
		  		alert("success");
		  	}).fail(function(response){
	         	alert("Unable to save the field:\n " + response.responseText);
	        });
  		}
  	});

  	$("#collectionModal .add-collection").on("click", "#btnSave", function(e) {
  		var collection_id = $(this).val();

  		 $.ajax({
	          url: '/videos/add_collection',
	          type: 'POST',
	          data: {
	            "collection_id": collection_id,
	            "video_id": $(this).attr("data-video-id")
	          }
	        }).done(function() {
		  		alert("success"); 
	        }).fail(function(response){
	          alert("Unable to save the field:\n " + response.responseText);
	        });
  	});  

  	// Filters and sorting
	//apply all filters at once
	var form = $("form[name=filters]");

	form.on('changeT', function () {
		console.log("changeT");				

		var arrHn = ipHN.getValue();
		$("#hnMin").val(arrHn[0]);
		$("#hnMax").val(arrHn[1]);

		var arrCn = ipCN.getValue();
		$("#cnMin").val(arrCn[0]);
		$("#cnMax").val(arrCn[1]);

		var arrEp = ipEP.getValue();		
		$("#epMin").val(arrEp[0]);
		$("#epMax").val(arrEp[1]);

		var arrAr = ipAR.getValue();
		$("#arMin").val(arrAr[0]);
		$("#arMax").val(arrAr[1]);

    	form.find("#page").val(1);
    	redirect_ajax(mode);
  	});
  	// form.on('keyup', function () {
   //  	form.find("#page").val(1);
   //  	redirect_ajax(mode);
  	// });

  	// Infinite scroll
  	if ($('#infinite-scrolling').size() > 0) {
    	$(window).on('scroll', function(e) {    		
	      	if ($(window).scrollTop() > $(document).height() - $(window).height() - 20)  {
	      		console.log("infinite-scrolling");
	        	form.find("#page").val(parseInt(form.find("#page").val()) + 1);
	        	redirect_ajax(mode);
	      	}

	      	$("#sidebar").css("height", $(document).height());
    	});
  	}

  	// Initial load  	
  	redirect_ajax(mode);
  	
});
